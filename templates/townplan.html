{% extends 'base.html' %}
{% block content %}
    <!-- Main Content -->
    <div class="main-content container-fluid pt-0 d-flex flex-row flex-column">

        <!-- Row - 1 for Stats-cards -->
        <div id = "stat-row" class="row g-2 mb-2 row-slim .stat-row">
            <div class="col-lg col-sm-6 mt-0 mb-0 pt-2">
                <div id="stat-card-1" class="card stat-card border-2 p-0 fade-in"
                    style="animation-delay: 0.1s;">
                    <div class="card-header">
                        <span class="">Residential</span>
                    </div>
                    <div class="card-body mt-0 p-0 ">
                        <h5 class="mb-0 px-2">9,115,990</h5>
                        
                        <small class="text-muted">Count of Plots</small>
                    </div>
                </div>
            </div>

            <div class="col-lg col-sm-6 mt-0 mb-0 pt-2">
                <div id="stat-card-2" class="card stat-card border-2 p-0 fade-in"
                    style="animation-delay: 0.2s;">
                    <div class="card-header">
                        <span class="">Commercial</span>
                    </div>
                <div class="card-body mt-0 p-0 ">
                        <h5 class="mb-0 px-2">1,435,990</h5>
                        
                        <small class="text-muted">Count of Plots</small>
                    </div>
                </div>
            </div>

            <div class="col-lg col-sm-6 mt-0 mb-0 pt-2">
                <div id="stat-card-3" class="card stat-card border-2 p-0 fade-in"
                    style="animation-delay: 0.3s;">
                    <div class="card-header">
                        <span class="">Education</span>
                    </div>
                   <div class="card-body mt-0 p-0 ">
                        <h5 class="mb-0 px-2">435,990</h5>
                        
                        <small class="text-muted">Count of Plots</small>
                    </div>
                </div>
            </div>

            <div class="col-lg col-sm-6 mt-0 mb-0 pt-2">
                <div id="stat-card-4" class="card stat-card border-2 p-0 fade-in" style="animation-delay: 0.45s;">
                    <div class="card-header">
                        <span class="">Amenities</span>
                    </div>
                    <div class="card-body mt-0 p-0 ">
                        <h5 class="mb-0 px-2">435,990</h5>
                        
                        <small class="text-muted">Count of Plots</small>
                    </div>
                </div>
            </div>

            <div class="col-lg col-sm-6 mt-0 mb-0 pt-2">
                <div id="stat-card-5" class="card stat-card border-2 p-0 fade-in" style="animation-delay: 0.6s;">
                    <div class="card-header">
                        <span class="">Parks</span>
                    </div>
                   <div class="card-body mt-0 p-0 ">
                        <h5 class="mb-0 px-2">435,990</h5>
                        
                        <small class="text-muted">Count of Plots</small>
                    </div>
                </div>
            </div>

        </div>

        <!-- Row - 2 for City-cards -->
        <div id = "station-cards" class="row g-2 mb-2 row-slim">
            <div class="col col-sm-6 -sm-4 col-md-4 col-lg">
                <div class="card city-card city-card-khi border-2 p-0" id="khi">
                    <div class="card-header mt-1">
                        <h6 class="mb-0 px-2">DHA K</h6>
                    </div>
                    <div class="card-body mt-1 p-0">
                        <p class="mb-0 px-2">550,000 <small class="text-muted">Plots</small></p>

                    </div>
                </div>
            </div>

            <div class="col col-sm-6 -sm-4 col-md-4 col-lg">
                <div class="card city-card city-card-lhr border-2 p-0" id="lhr">
                    <div class="card-header mt-1">
                        <h6 class="mb-0 px-2">DHA L</h6>
                    </div>
                    <div class="card-body mt-1 p-0">
                        <p class="mb-0 px-2">450,000 <small class="text-muted">Plots</small></p>

                    </div>
                </div>
            </div>

            <div class="col col-sm-6 -sm-4 col-md-4 col-lg">
                <div class="card city-card city-card-isl border-2 p-0" id="isl">
                    <div class="card-header mt-1">
                        <h6 class="mb-0 px-2">DHA IR</h6>
                    </div>
                    <div class="card-body mt-1 p-0">
                        <p class="mb-0 px-2">250,000 <small class="text-muted">Plots</small></p>

                    </div>
                </div>
            </div>

            <div class="col col-sm-6 -sm-4 col-md-4 col-lg">
                <div class="card city-card city-card-qut border-2 p-0" id="qut">
                    <div class="card-header mt-1">
                        <h6 class="mb-0 px-2">DHA Q</h6>
                    </div>
                    <div class="card-body mt-1 p-0">
                        <p class="mb-0 px-2">300,000 <small class="text-muted">Plots</small></p>

                    </div>
                </div>
            </div>

            <div class="col col-sm-6 -sm-4 col-md-4 col-lg">
                <div class="card city-card city-card-mul border-2 p-0" id="mul">
                    <div class="card-header mt-1">
                        <h6 class="mb-0 px-2">DHA M</h6>
                    </div>
                    <div class="card-body mt-1 p-0">
                        <p class="mb-0 px-2">990,000 <small class="text-muted">Plots</small></p>

                    </div>
                </div>
            </div>

            <div class="col col-sm-6 -sm-4 col-md-4 col-lg">
                <div class="card city-card city-card-bhw border-2 p-0" id="bhw">
                    <div class="card-header mt-1">
                        <h6 class="mb-0 px-2">DHA B</h6>
                    </div>
                    <div class="card-body mt-1 p-0">
                        <p class="mb-0 px-2">800,000 <small class="text-muted">Plots</small></p>

                    </div>
                </div>
            </div>

            <div class="col col-sm-6 -sm-4 col-md-4 col-lg">
                <div class="card city-card city-card-guj border-2 p-0" id="guj">
                    <div class="card-header mt-1">
                        <h6 class="mb-0 px-2">DHA G</h6>
                    </div>
                    <div class="card-body mt-1 p-0">
                        <p class="mb-0 px-2">300,000 <small class="text-muted">Plots</small></p>
                    </div>
                </div>
            </div>

            <div class="col col-sm-6 -sm-4 col-md-4 col-lg">
                <div class="card city-card city-card-city border-2 p-0" id="city">
                    <div class="card-header mt-1">
                        <h6 class="mb-0 px-2">DHA CITY</h6>
                    </div>
                    <div class="card-body mt-1 p-0">
                        <p class="mb-0 px-2">500,000 <small class="text-muted">Plots</small></p>

                    </div>
                </div>
            </div>

            <div class="col col-sm-6 -sm-4 col-md-4 col-lg">
                <div class="card city-card city-card-psw border-2 p-0" id="psw">
                    <div class="card-header mt-1">
                        <h6 class="mb-0 px-2">DHA P</h6>
                    </div>
                    <div class="card-body mt-1 p-0">
                        <p class="mb-0 px-2">450,000<small class="text-muted">Plots</small></p>

                    </div>
                </div>
            </div>
        
        </div>

        <!-- Row - 3 for Charts and Map Panel-->
        <div class="row g-3 flex-grow-1 row-main">

            <!-- Progress bars / Charts Panel-->

            <div class="col-12 col-lg-3 order-1 order-lg-1">
                <!-- Progress bars -->
                <div id="progressbarspanel" class="charts-panel h-100 d-flex flex-column pt-0 px-0">
                    <div class="chart-wrapper">
                        <div class="chart-header"> Distribution of Plots - DHA Wise Statistics</div>
                        <div class="progress-container m-0 p-0">
                            <div class="progress-item mb-2"></div>
                            <div class="progress-item mb-2"></div>
                            <div class="progress-item mb-2"></div>
                            <div class="progress-item mb-2"></div>
                            <div class="progress-item mb-2"></div>
                            <div class="progress-item mb-2"></div>
                            <div class="progress-item mb-2"></div>
                            <div class="progress-item mb-2"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Charts Panel-->
                <div id="stationwisechartpanel" class="charts-panel-back h-100 d-flex flex-column pt-0 px-0">
                    <div class="chart-wrapper flex-grow-0">
                        <div class="chart-header"> DHA K - Phase Wise Plots Distribution</div>
                        <div id="pie-chart" class="chart-body m-0 p-0"></div>
                    </div>
                    <div class="chart-wrapper flex-grow-1">
                        <div class="chart-header"> DHA K - Plot Categories</div>
                        <div id="bar-chart" class="chart-body"></div>
                    </div>
                </div>
                <!-- Authors -->
                <div class="small authors fw-light px-2 p-0 m-0">Developed by <a href="https://www.r2v.com"
                        target="_blank">www.r2v.com</a></small></div>
            </div>

            <!-- Map Panel -->
            <div class="col-12 col-lg-9 order-2 order-lg-2">
                <div class="map-panel h-100">
                    <div id="map"></div>
                    <div id="legend" class="position-absolute end-0 top-0 m-0 shadow map-overlay-box m-2">
                        <h6 class="mb-3">Map Legend</h6>
                        <button class="close-btn btn-red" aria-label="Close">×</button>
                        <div id = "legend-content" class="legend-content">
                            <div class="legend-item">
                                <div class="d-flex align-items-center">
                                    <input type="checkbox" id="phase1" class="legend-checkbox me-2" checked>
                                    <label for="running-checkbox" class="legend-label mb-0">
                                        <span class="legend-icon icon1"></span>
                                        <span>Residential</span>
                                    </label>
                                </div>
                            </div>
                            <div class="legend-item">
                                <div class="d-flex align-items-center">
                                    <input type="checkbox" id="" value="0" class="legend-checkbox me-2" checked>
                                    <label for="running-checkbox" class="legend-label mb-0">
                                        <span class="legend-icon icon2"></span>
                                        <span>Commercial</span>
                                    </label>
                                </div>
                            </div>
                            <div class="legend-item">
                                <div class="d-flex align-items-center">
                                    <input type="checkbox" id="" value="0" class="legend-checkbox me-2" checked>
                                    <label for="running-checkbox" class="legend-label mb-0">
                                        <span class="legend-icon icon5"></span>
                                        <span>Education</span>
                                    </label>
                                </div>
                            </div>
                            <div class="legend-item">
                                <div class="d-flex align-items-center">
                                    <input type="checkbox" id="" value="0" class="legend-checkbox me-2" checked>
                                    <label for="running-checkbox" class="legend-label mb-0">
                                        <span class="legend-icon icon6"></span>
                                        <span>Amenities</span>
                                    </label>
                                </div>
                            </div>
                            <div class="legend-item">
                                <div class="d-flex align-items-center">
                                    <input type="checkbox" id="" value="0" class="legend-checkbox me-2" checked>
                                    <label for="running-checkbox" class="legend-label mb-0">
                                        <span class="legend-icon icon3"></span>
                                        <span>Parks</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <script>


let townData;


document.addEventListener('DOMContentLoaded', function () {
    showSkeleton(".card-body", 2);
    showSkeleton('.progress-item',1);
    showSkeleton('.legend-content',2);
    // Call the API when page loads
    fetchTownplanData();
});



// Fetch with cache
async function fetchTownplanData() {

    fetch("{% url 'town_summary' %}")
        .then(response => response.json())
        .then(data => {

            // Get the desired order of keys
            data.stations = sortStationsGlobally(data.stations);


            townData = data; // ✅ Store globally
            updateStatCards(townData.total_summary);
            updateStationCards(townData.stations);
            updateProgressBars(townData.stations);
        })
        .catch(error => {
            console.error('Error fetching land summary:', error);
            showToast("Failed to fetch data. Please try again later.","error");
        })
        .finally(() => {
            hideLoader();
            hideSkeleton(".card-body");
        });
}

// Render stat cards
function updateStatCards(summary) {
    const container = document.getElementById("stat-row");
    container.innerHTML = "";

    const map_container = document.getElementById("legend-content");
    map_container.innerHTML = "";

    const categories = ["Residential", "Commercial", "Education", "Amenities", "Parks"];
    categories.forEach((cat, i) => {
        const value = summary[cat] || 0;

        console.log(cat, value, i)
        const card = document.createElement("div");
        card.className = `col-lg col-sm-6 mt-1 mb-0 pt-2`;

        card.innerHTML = `
                <div id="stat-card-1" class="card stat-card border-2 p-0 ${i == 0 ? "selected" : ""}"  style="animation-delay: 0.1s;"  data-category="${cat}">
                    <div class="card-header">
                        <span class="">${cat}</span>
                    </div>
                    <div class="card-body mt-0 p-0 ">
                        <h5 class="mb-0 px-2">${value.toLocaleString()}</h5>
                        <small class="text-muted">Count of Plots</small>
                    </div>
                </div>
        `;
        container.appendChild(card);


        const legendItem = document.createElement("div");
        legendItem.className = `legend-item`;

        legendItem.innerHTML = `
                    <div class="d-flex align-items-center" data-category="${cat}">
                        <input type="checkbox" id="phase1" class="legend-checkbox me-2" onchange="toggleLayer('${cat}', this.checked, null)">
                        <label for="running-checkbox" class="legend-label mb-0">
                            <span class="legend-icon icon${(i+6)%6+1}"></span>
                            <span>${cat}</span>
                        </label>
                    </div>
        `;

        map_container.appendChild(legendItem);
    });
}

// Render station-wise cards
function updateStationCards(stations, category = "Residential") {



  const container = document.getElementById("station-cards");
  container.innerHTML = "";

  stations.forEach(st => {
    const phase1 = st.phases.phase1?.[category] || 0;
    const phase2 = st.phases.phase2?.[category] || 0;
    const total = phase1 + phase2;

    const card = document.createElement("div");
    card.className = "col col-sm-6 -sm-4 col-md-4 col-lg";


      card.innerHTML = `
            <div class="card city-card city-card-khi border-2 p-0" id="khi" data-station="${st.station_name}">
                <div class="card-header mt-1">
                    <h6 class="mb-0 px-2">${mapDHATag[st.station_name]}</h6>
                </div>
                <div class="card-body mt-1 p-0">
                    <p class="mb-0 px-2">${total.toLocaleString()} <small class="text-muted">Plots</small></p>

                </div>
            </div>`;
    container.appendChild(card);
  });
}


// -------------------------
// Selections
// -------------------------

// Stat Cards
document.addEventListener('click', function (e) {
    const card = e.target.closest('.stat-card'); 
    if (!card) return; // Not a stat-card, ignore it

    // Remove selected from all
    document.querySelectorAll('.stat-card').forEach(c => c.classList.remove('selected'));
    document.querySelectorAll('.city-card').forEach(c => c.classList.remove('selected'));

    // Add selected to clicked one
    card.classList.add('selected');

    const id = card.id;
    const type = id.replace('stat-card-', '');

    const category = e.target.closest('.stat-card')?.dataset.category

    updateStationCards(townData.stations, category);


    // Generate Cards
    updateProgressBars(townData.stations, category);
    resetMap();
    const chartTitle = type.charAt(0).toUpperCase() + type.slice(1);
    // document.querySelector('#phaseChartTitle').textContent = `${category} Plot - DHA Wise Statistics`;
});




// Station Cards
document.addEventListener('click', function (e) {
    const card = e.target.closest('.city-card'); 
    if (!card) return; // Not a stat-card, ignore it

    // Remove selected from all
    document.querySelectorAll('.city-card').forEach(c => c.classList.remove('selected'));

    // Add selected to clicked one
    card.classList.add('selected');

    const id = card.id;
    const type = id.replace('city-card-', '');


    const station_name = e.target.closest('.city-card')?.dataset.station;

    const station = townData.stations.find(st => st.station_name === station_name);

    const selectedCard = document.querySelector('.stat-card.selected');
    const category = selectedCard ? selectedCard.dataset.category : null;

    setMap(category, null,mapDHATag[station_name]);

    updateStationBarChart(station);
    updateStationPieChart(station);
});



// -------------------------
// Graphs
// -------------------------


// -------------------------
// Update Progress Bars
// -------------------------

function updateProgressBars(stations, selectedType = 'Residential') {
    const panel = document.getElementById('progressbarspanel');
    const title = panel.querySelector('.chart-header');

    // Update heading
    // const titleMap = {
    //     possessed: 'Possessed Land — DHA Wise Statistics',
    //     unpossessed: 'Unpossessed Land — DHA Wise Statistics',
    //     unpurchased: 'Possessed Not Purchased — DHA Wise Statistics',
    //     hold: 'Hold Land — DHA Wise Statistics',
    //     litigation: 'Litigation Land — DHA Wise Statistics'
    // };
    // title.textContent = titleMap[selectedType] || 'Land Summary — DHA Wise Statistics';

    // Build HTML dynamically
    const container = panel.querySelector('.progress-container');
    container.innerHTML = ''; // Clear old bars

    stations.forEach(st => {
        const name = st.station_name;
        // const cls = name.toLowerCase().replace('_', '');

        const cls =  mapCityToId[st.station_name].replace('#', '');


        const val = st.totals[selectedType];

        const total = townData.total_summary[selectedType] || 1; // avoid divide-by-zero

        const percent = ((val / total) * 100).toFixed(1);


        const item = document.createElement('div');
        item.className = 'progress-item mb-2';
        item.innerHTML = `
            <div class="progress-label">
                <span class="district-name">${mapDHATag[st.station_name]}</span>
                <div class="d-flex inline-flex">
                    <span class="progress-value">${val.toLocaleString()} / ${total.toLocaleString()} Total Plots</span>
                </div>
            </div>
            <div class="custom-progress">
                <div class="custom-progress-bar ${cls}" style="width: ${percent}%">
                    <span class="progress-percentage">${percent}%</span>
                </div>
            </div>`;
        container.appendChild(item);
    });
}



function updateStationBarChart(station) {
  const totals = station.totals || {};
  const name = station.station_name || 'Unknown';

  // Update chart title
  document.querySelector('#stationwisechartpanel .chart-wrapper:nth-child(2) .chart-header')
    .textContent = `${mapDHATag[name]} - Plot Categories`;

  const categories = [
    "Residential",
    "Commercial",
    "Education",
    "Amenities",
    "Parks",
  ];

  const values = [
    totals.Residential || 0,
    totals.Commercial || 0,
    totals.Education || 0,
    totals.Amenities || 0,
    totals.Parks || 0,
  ];

  const colors = ['#f99d5f', '#75f577', '#25e17a', '#92a5f9', '#6cadee', '#c95a5a'];

  Highcharts.chart('bar-chart', {
    chart: {
      type: 'column',
      backgroundColor: 'transparent',
      height: '66%',
      spacing: [0, 0, 0, 0],
      marginLeft: 2
    },
    title: { text: null },
    xAxis: {
      categories,
      title: { text: 'Plot Categories' },
      labels: { enabled: false },
      lineWidth: 0,
      tickLength: 0
    },
    yAxis: {
      title: { text: 'Plots' },
      labels: {
        style: { fontSize: '9px', color: '#333' }
      },
      gridLineColor: '#e2e8f0'
    },
    legend: { enabled: false },
    credits: { enabled: false },
    plotOptions: {
      column: {
        pointPadding: 0.7,
        groupPadding: 0.05,
        pointWidth: 40,
        borderRadius: 4,
        states: {
          hover: { brightness: -0.4 }
        },
        dataLabels: {
          enabled: true,
          useHTML: true,
          inside: false,
          y: -18,
          style: {
            color: '#3b3f46',
            fontSize: '9px',
            fontWeight: 'normal',
            textOutline: 'none',
            textShadow: 'none'
          },
          formatter: function () {
            return `${this.point.name}:<br/>
                    <strong>${Highcharts.numberFormat(this.y, 0)}</strong><br/>
                    Plots`;
          }
        }
      }
    },
    series: [{
      name: 'Count',
      data: categories.map((cat, i) => ({
        name: cat,
        y: values[i],
        color: colors[i]
      })),
      colorByPoint: true
    }]
  });
}



function updateStationPieChart(station) {

    // Update chart title
    document.querySelector('#stationwisechartpanel .chart-wrapper:nth-child(1) .chart-header')
    .textContent = `${mapDHATag[station.station_name]} - Phase Wise Plots Distribution`;


    // const phases = station.phases;
    // if (!phases) return;

    // const data = Object.entries(phases).map(([name, vals]) => ({
    //     name: `${name}`,
    //     y: vals.purchased || 0
    // }));


    // Get selected category from active stat-card
    const selectedCard = document.querySelector('.stat-card.selected');
    const category = selectedCard ? selectedCard.dataset.category : null;

    // Bail early if no category or no phases
    if (!category || !station.phases) return;

    // Build Highcharts-compatible data dynamically
    const data = Object.entries(station.phases).map(([phaseName, values]) => ({
        name: phaseName.replace(/([a-zA-Z]+)(\d+)/, (_, n, d) => n.charAt(0).toUpperCase() + n.slice(1) + '-' + d),
        y: Number(values[category]) || 0
    }));


    

    Highcharts.chart('pie-chart', {
        chart: {
            type: 'pie',
            backgroundColor: 'transparent',
            height: '60%'
        },
        title: { text: null },
        tooltip: {
            pointFormat: '{series.name}: <b>{point.y:.2f}</b>'
        },
        plotOptions: {
            pie: {
                allowPointSelect: true,
                cursor: 'pointer',
                dataLabels: {
                    enabled: true,
                    format: '<b>{point.name}</b>: {point.percentage:.1f} %'
                }
            }
        },
        credits: { enabled: false },
        series: [{
            name: 'Total',
            colorByPoint: true,
            data
        }]
    });
}



    </script>
{% endblock %}